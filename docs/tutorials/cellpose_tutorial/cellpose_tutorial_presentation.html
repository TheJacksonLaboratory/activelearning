<!DOCTYPE html>
<html lang="en"><head>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.40">

  <meta name="author" content="Fernando Cervantes">
  <title>Tutorial: How to fine tune a Cellpose model with the Active Learning plugin for Napari</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/theme/quarto-76747c94a35996ac0b5265139f68aa0e.css">
  <link href="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Tutorial: How to fine tune a Cellpose model with the Active Learning plugin for Napari</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Fernando Cervantes 
</div>
</div>
</div>

</section>
<section>
<section id="install-napari-and-the-active-learning-plugin" class="title-slide slide level1 center">
<h1>1. Install <code>napari</code> and the Active Learning plugin</h1>

</section>
<section class="slide level2">

<h3 id="install-napari">1.1. Install <code>napari</code></h3>
<p>Follow the instructions to install <code>napari</code> from its <a href="https://napari.org/stable/tutorials/fundamentals/installation.html#napari-installation">official website</a>.</p>
<h3 id="install-the-napari-activelearning-plugin-using-pip">1.2. Install the <code>napari-activelearning</code> plugin using <code>pip</code></h3>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>If you installed <code>napari</code> using conda, activate that same environment before installing the <em>Active Learning</em> plugin.</p>
</div>
</div>
</div>
<p>Install the plugin adding <code>[cellpose]</code> to the command so all dependencies required for this tutorial are available.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a></a><span class="ex">python</span> <span class="at">-m</span> pip install <span class="st">"napari-activelearning[cellpose]"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<h3 id="launch-napari">1.3. Launch <code>napari</code></h3>
<p>From a console, open <code>napari</code> with the following command:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a></a><span class="ex">napari</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Caution</strong></p>
</div>
<div class="callout-content">
<p>The first time <code>napari</code> is launched it can take more than <span class="math inline">\(30\)</span> seconds to open, so please be patient!</p>
</div>
</div>
</div>
</section></section>
<section>
<section id="image-groups-management" class="title-slide slide level1 center">
<h1>2. Image groups management</h1>

</section>
<section id="load-a-sample-image" class="slide level2">
<h2>2.1. Load a sample image</h2>
<p>You can use the cells 3D image sample from napari’s built-in samples.</p>
<pre><code>File &gt; Open Sample &gt; napari builtins &gt; Cells (3D+2Ch)</code></pre>

<img data-src="cellpose_tutorial_files/figure-html/cell-5-output-1.png" class="r-stretch"></section>
<section id="add-the-image-groups-manager-widget-to-naparis-window" class="slide level2">
<h2>2.2. Add the <em>Image Groups Manager</em> widget to napari’s window</h2>
<p>The <em>Image groups manager</em> can be found under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Image groups manager</code></pre>
<div title="About the _Image groups manager_">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>About the <em>Image groups manager</em></strong></p>
</div>
<div class="callout-content">
<p>The <em>Image groups manager</em> widget is used to create <em>groups</em> of layers and their specific use within the <code>active-learning</code> plugin. It allows to specify properties and metadata of such layers (e.g.&nbsp;inputs paths, output directory, axes order, etc.) that are used by the <em>Acquisition Function Configuration</em> widget.</p>
<p>This widget allows to relate different layers using a single hierarchical structure (<em>image group</em>). Such hierarchical structure is implemented as follows:</p>
<ul>
<li><p><em>Image groups</em>. Used to contain different modes of data from a single object, such as image pixels, labels, masks, etc.</p>
<ul>
<li><p><em>Layers groups</em>. These group multiple layers of the same mode together, e.g.&nbsp;different channel layers of the same image.</p>
<ul>
<li><em>Layer channels</em>. This is directly related to elements in <code>napari</code>’s <em>layer list</em>. Moreover, <em>layer channels</em> allow to store additional information or <em>metadata</em> useful for the inference and fine-tuning processes.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-8-output-1.png" class="r-stretch"></section>
<section id="create-an-image-group-containing-nuclei-and-membrane-layers" class="slide level2">
<h2>2.3. Create an <em>Image Group</em> containing <em>nuclei</em> and <em>membrane</em> layers</h2>
<ol type="1">
<li><p>Select the <em>nuclei</em> and <em>membrane</em> layer.</p></li>
<li><p>Click the <em>New Image Group</em> button on the <em>Image Groups Manager</em> widget.</p></li>
</ol>

<img data-src="cellpose_tutorial_files/figure-html/cell-10-output-1.png" class="r-stretch"></section>
<section id="edit-the-image-group-properties" class="slide level2">
<h2>2.4. Edit the image group properties</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<ol type="1">
<li><p>Select the “images” layers group_ that has been created under the new image group.</p></li>
<li><p>Click the <em>Edit group properties</em> checkbox.</p></li>
<li><p>Make sure that <em>Axes order</em> is “CZYX”, otherwise, you can edit it and press <em>Enter</em> to update the axes names.</p></li>
</ol>
</div><div class="column" style="width:0.7;">
<div id="b80bc53a" class="cell" data-execution_count="12">
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-13-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section></section>
<section>
<section id="segmentation-on-image-groups" class="title-slide slide level1 center">
<h1>3. Segmentation on image groups</h1>

</section>
<section id="add-the-acquisition-function-configuration-widget-to-naparis-window" class="slide level2">
<h2>3.1. Add the <em>Acquisition function configuration</em> widget to napari’s window</h2>
<p>The <em>Acquisition function configuration</em> is under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Acquisition function configuration</code></pre>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>All <em>Active Learning</em> widgets can be <em>un-docked</em> from their current place and <em>re-docked</em> into other more convenient location within <code>napari</code>’s window, or even as tabs, as illustrated in this tutorial.</p>
</div>
</div>
</div>
<div title="About the _Acquisition function configuration_">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>About the <em>Acquisition function configuration</em></strong></p>
</div>
<div class="callout-content">
<p>The <em>Acquisition function configuration</em> widget comprises the processes of <em>inference</em> and <em>fine tunning</em> of deep learning models.</p>
<p>This tool allows to define the sampling configuration used to retrieve patches from the <em>input</em> image at random. Such configuration involves the size on each dimension of the patches, the maximum number of patches that can be sampled from each image, and the order of the axes that are passed to the model’s inference function. Parameters for such model can also be configured within this widget.</p>
<p>The fine-tuning process can also be configured and launched from within this widget. Finally, this widget executes the inference process on the same sampled patches to compare the <em>base</em> and <em>fine-tuned</em> model performance visually.</p>
</div>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-16-output-1.png" class="r-stretch"><p>:::</p>
<p>::::</p>
</section>
<section id="set-the-size-of-the-sampling-patch" class="slide level2">
<h2>3.3. Set the size of the sampling patch</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<div id="d8adb455" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display" data-execution_count="17">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-18-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div><div class="column" style="width:0.7;">
<ol type="1">
<li>Click the “Edit patch size” checkbox</li>
<li>Change the patch size of “X” and “Y” to 256, and the “Z” axis to 1.</li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This directs the Active Learning plugin to sample at random patches of size <span class="math inline">\(256\times256\)</span> pixels and <span class="math inline">\(1\)</span> slice deep.</p>
</div>
</div>
</div>
</div></div>
</section>
<section id="sec-max-samples" class="slide level2">
<h2>3.4. Define the maximum number of samples to extract</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<div id="e1d42766" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-20-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div><div class="column" style="width:0.7;">
<ul>
<li>Set the “Maximum samples” to <span class="math inline">\(4\)</span> and press <em>Enter</em></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This tells the Active Learning plugin to process at most <em>four</em> samples at random from the whole image.</p>
<p>Because the image is of size <span class="math inline">\(256\times256\)</span> pixels, four whole slices will be sampled at random for segmentation.</p>
</div>
</div>
</div>
</div></div>
</section>
<section id="configure-the-segmentation-method" class="slide level2">
<h2>3.5. Configure the segmentation method</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Use the “Model” dropdown list to select the <code>cellpose</code> method</p></li>
<li><p>Click the “Advanced segmentation parameters” checkbox</p></li>
<li><p>Change the second channel to <span class="math inline">\(1\)</span> (the right spin box in the “channels” row)</p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This tells <code>cellpose</code> to segment the first channel (<span class="math inline">\(0\)</span>) and use the second channel (<span class="math inline">\(1\)</span>) as help channel.</p>
</div>
</div>
</div>
<ol start="4" type="1">
<li>Choose the “nuclei” model from the dropdown list</li>
</ol>
</div><div class="column" style="width:0.3;">
<!-- #endregion -->
<div id="337af82a" class="cell" data-execution_count="21">
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-22-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="sec-segment" class="slide level2">
<h2>3.6. Execute the segmentation method on all image groups</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ul>
<li>Click the “Run on all image groups” button</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>To execute the segmentation only on specific image groups, select the desired image groups in the <em>Image groups manager</em> widget and use the “Run on selected image groups” button instead.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="cd63b8c3" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display" data-execution_count="22">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-23-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="inspect-the-segmentation-layer" class="slide level2">
<h2>3.7. Inspect the segmentation layer</h2>
<ul>
<li>We will only see four segmented slices from the whole image. This is because we set the “Maximum samples” parameter to <span class="math inline">\(4\)</span> in <a href="#/sec-max-samples" class="quarto-xref">Section&nbsp;3.3</a>.</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Because the input image is 3D, you may have to slide the “Z” index at the bottom of napari’s window to look at the samples that were segmented.</p>
</div>
</div>
</div>
<div title="About the newly added layers">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>About the newly added layers</strong></p>
</div>
<div class="callout-content">
<p>Three new layers were added to the <code>napari</code>’s layers list after executing the segmentation pipeline.</p>
<p>The “images acquisition function” presents a map of the confidence prediction made by the chosen model for each sampled patch. Lighter intensity correspond to regions where the annotator should pay attention when correcting the output labels, since those are low-confidence predictions. On the other hand, darker intensity corresponds to high-confidence predictions, and correcting these labels would not have much impact in the performance of the fine-tuned model as correcting low-confidence (lighter intensity) regions.</p>
<p>The “images sampled positions” show a low-resolution map of the regions that were sampled during the segmentation process.</p>
<p>The “images segmentation” layer are the output labels predicted by the model.</p>
<p>Note that the name of those three generated layers contain the name of the <em>image group</em> from where those patches were sampled, in this case the “images” <em>image group</em>.</p>
</div>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-26-output-1.png" class="r-stretch"></section></section>
<section>
<section id="sec-mask" class="title-slide slide level1 center">
<h1>4. Segment masked regions only</h1>

</section>
<section id="create-a-mask-to-restrict-the-sampling-space" class="slide level2">
<h2>4.1. Create a mask to restrict the sampling space</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Switch to the <em>Image groups manager</em> tab</p></li>
<li><p>Click the “Edit mask properties” checkbox</p></li>
<li><p>Set the mask scale to <span class="math inline">\(256\)</span> for the “X” and “Y” axes, and a scale of <span class="math inline">\(1\)</span> for the “Z” axis</p></li>
<li><p>Click the “Create mask” button</p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This creates a low-resolution mask where each of its pixels corresponds to a <span class="math inline">\(256\times256\)</span> pixels region in the input image. Because the mask is low-resolution, it uses less space in memory and disk. The new mask will appear as “images mask (1)” since there already exists one mask that was generated automatically when running the segmentation method in step <a href="#/sec-segment" class="quarto-xref">Section&nbsp;3.5</a>.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="a31a11eb" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display" data-execution_count="27">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-28-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="specify-the-samplable-regions" class="slide level2">
<h2>4.2. Specify the samplable regions</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Make sure the newly created layer “images mask (1)” is selected.</p></li>
<li><p>Activate the <em>fill bucket</em> tool (or press <em>4</em> or <em>F</em> keys in the keyboard as shortcuts).</p></li>
<li><p>Click the image to draw the mask on the current slice.</p></li>
<li><p>Move the slider at the bottom of napari’s window to navigate between slices in the “Z” axis. Select slice <span class="math inline">\(28\)</span> and draw on it as in step <span class="math inline">\(3\)</span>. Repeat with slices <span class="math inline">\(29\)</span> and <span class="math inline">\(30\)</span>.</p></li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="1284b4ce" class="cell" data-execution_count="29">
<div class="cell-output cell-output-display" data-execution_count="29">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-30-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="execute-the-segmentation-process-on-the-masked-regions" class="slide level2">
<h2>4.3. Execute the segmentation process on the masked regions</h2>
<ul>
<li>Return to the <em>Acquisition function configuration</em> tab and run the segmentation process again (clicking “Run on all image groups” button).</li>
</ul>

<img data-src="cellpose_tutorial_files/figure-html/cell-33-output-1.png" class="r-stretch"></section>
<section id="inspect-the-results-from-the-segmentation-applied-only-to-masked-regions" class="slide level2">
<h2>4.4. Inspect the results from the segmentation applied only to masked regions</h2>
<ul>
<li>All slices between <span class="math inline">\(27\)</span> and <span class="math inline">\(30\)</span> were picked and segmented thanks to the sampling mask!</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>At this point, multiple layers have been added to <code>napari</code>’s layers list and it could start to look clutered.</p>
<p>The following layers will be used in the remainder of this tutorial: “membrane”, “nuclei”, “images mask (1)”, and “images segmentation [1]”.</p>
<p>The rest of the layers can be safely removed from the list (i.e.&nbsp;“images acquisition function [1]”, “images acquisition function”, “images mask”, and “images segmentation”).</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-36-output-1.png" class="r-stretch"></section></section>
<section>
<section id="fine-tune-the-segmentation-model" class="title-slide slide level1 center">
<h1>5. Fine tune the segmentation model</h1>

</section>
<section id="add-the-label-groups-manager-widget-to-naparis-window" class="slide level2">
<h2>5.1. Add the <em>Label groups manager</em> widget to napari’s window</h2>
<p>You can find the <em>Label groups manager</em> under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Label groups manager</code></pre>
<div title="About the _Label groups manager_">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>About the <em>Label groups manager</em></strong></p>
</div>
<div class="callout-content">
<p>The <em>Label groups manager</em> widget contains the coordinates of the sampled patches acquired by the <em>Acquisition function configuration</em> widget.</p>
<p>This widget allows to navigate between patches without serching them in the complete extent of their corresponding image. It additionally permits to edit the pixel data of the selected patch’s <em>labels</em> in order to correct the inference output in a <em>human-in-the-loop</em> approach.</p>
</div>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-40-output-1.png" class="r-stretch"></section>
<section id="navigate-between-patches-with-the-label-groups-manager" class="slide level2">
<h2>5.2. Navigate between patches with the <em>Label groups manager</em></h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Select the last <em>labels group</em> “Labels of groups: images” added to the manager. If you have not removed any layers from <code>napari</code>’s layers list, it should be the second group, otherwise, it will be the only group available.</p></li>
<li><p>Select the first <em>label</em> in such group.</p></li>
<li><p>Use the navigation buttons to move between labels.</p></li>
</ol>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Caution</strong></p>
</div>
<div class="callout-content">
<p>Selecting a <em>label</em> element in the <em>label groups manager</em> will toggle all layers visible. You can hide again any layer that blocks the visibility of objects of interest.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="cbd95b67" class="cell" data-execution_count="41">
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-42-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch" class="slide level2">
<h2>5.3. Use napari’s layer controls to make changes on the objects of the current patch</h2>
<ol type="1">
<li>Select the <em>label</em> associated to the patch extracted at slice <span class="math inline">\(27\)</span>. That label can be found by looking for the coordinate <span class="math inline">\((0, 0, 27, 0, 0)\)</span> in the “Sampling top-left” column of the <em>label groups manager</em> table.</li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This creates a new editable “Labels edit” layer with a copy of the selected patch.</p>
</div>
</div>
</div>
<ol start="2" type="1">
<li><p>Make sure the “Labels edit” layer is selected.</p></li>
<li><p>Edit the labels on the current patch with <code>napari</code>’s annotation tools.</p></li>
</ol>
<div title="How to use the annotation tools">
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>How to use the annotation tools</strong></p>
</div>
<div class="callout-content">
<ol type="1">
<li><p>Select the <em>pick mode</em> tool (click the dropper icon or press key <em>5</em> or <em>L</em> on the keyboard) and click on an object in the current patch to get its label index.</p></li>
<li><p>Use the <em>paint brush</em> (click the brush icon or press key <em>2</em> or <em>P</em> on the keyboard) and add pixels missed by the model.</p></li>
<li><p>Remove extra pixels with the <em>label eraser</em> tool (click the eraser icon or press key <em>1</em> or <em>E</em> on the keyboard).</p></li>
<li><p>If an object was not segmented at all, press the <em>M</em> key on the keyboard to get the next <em>unused</em> label index, and use the <em>paint brush</em> as in step <span class="math inline">\(2\)</span> to cover the pixels of that object.</p></li>
</ol>
<p>For a more complete guide on annotation with <code>napari</code> follow <a href="https://napari.org/stable/howtos/layers/labels.html#creating-deleting-merging-and-splitting-connected-components">this tutorial</a>.</p>
</div>
</div>
</div>
</div>
<ol start="4" type="1">
<li>Click the “Commit changes” button when finished editing.</li>
</ol>

<img data-src="cellpose_tutorial_files/figure-html/cell-44-output-1.png" class="r-stretch"></section>
<section id="edit-labels-on-other-slices" class="slide level2">
<h2>5.4. Edit labels on other slices</h2>
<ul>
<li>Continue editing the labels of the other patches until these are closer to what the model is expected to predict.</li>
</ul>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>The <code>cellpose</code> model used in this tutorial does not work with sparse labeling, so its important that all the objects that are of interest should be labeled.</p>
<p>Additionally, the performance of the <em>fine-tuned</em> model will depend highly on how precise the objects were labeled.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-47-output-1.png" class="r-stretch"></section>
<section id="select-the-layer-group-that-will-be-used-as-labels-for-fine-tuning" class="slide level2">
<h2>5.5. Select the <em>layer group</em> that will be used as labels for <em>fine-tuning</em></h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li>Go to the <em>image groups manager</em> widget and select the “segmentation (1)” <em>layers group</em>.</li>
</ol>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>The “Group name” column in the groups table can be resized to show the complete names.</p>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Open the <em>Edit group properties</em> view (clicking on the checkbox) and tick the “Use as labels” checkbox.</li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Any <em>layers group</em> can be used as labels for the <em>fine-tuning</em> process, just make sure the layer type is appropriate for the training workflow of the model to fine-tune.</p>
<p>In this tutorial, the labels must be of <code>napari.layers.Labels</code> type.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="8c62547f" class="cell" data-execution_count="48">
<div class="cell-output cell-output-display" data-execution_count="48">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-49-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="setup-fine-tuning-configuration" class="slide level2">
<h2>5.6. Setup fine tuning configuration</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Go to the <em>Acquisition function configuration</em> widget and click the “Advanced fine tuning parameters” checkbox</p></li>
<li><p>Change the “save path” to a location where you want to store the fine tuned model</p></li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="296434e1" class="cell" data-execution_count="51">
<div class="cell-output cell-output-display" data-execution_count="51">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-52-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="setup-fine-tuning-configuration-1" class="slide level2">
<h2>5.6. Setup fine tuning configuration</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol start="4" type="1">
<li>Change the “model name” to “nuclei_ft”</li>
</ol>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Scroll the <em>Advanced fine tuning parameters</em> widget down to show more parameters.</p>
</div>
</div>
</div>
<ol start="5" type="1">
<li><p>Set the “batch size” to <span class="math inline">\(3\)</span></p></li>
<li><p>Change the “learning rate” to <span class="math inline">\(0.0001\)</span></p></li>
</ol>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>You can modify other parameters for the training process here, such as the number of training epochs.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="1a8613c0" class="cell" data-execution_count="53">
<div class="cell-output cell-output-display" data-execution_count="53">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-54-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="execute-the-fine-tuning-process" class="slide level2">
<h2>5.7. Execute the fine tuning process</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<div title="Double check the fine-tuning parameters!">
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Double check the fine-tuning parameters!</strong></p>
</div>
<div class="callout-content">
<p>Because <em>spin boxes</em> in this widget can be modified by <em>hovering</em> and <em>scrolling</em> with the mouse, it is possible to change their values when scrolling down the parameters window.</p>
<p>Make sure that the parameters are the same as the shown in the following screenshot, particularly the size of the crops used for <em>data augmentation</em> (<em>bsize</em>), and the number of images per epoch (<em>nimg per epoch</em>).</p>
<p><img data-src="finetuning_parameter_values.png"></p>
</div>
</div>
</div>
</div>
<ul>
<li>Click the “Fine tune model” button to run the training process.</li>
</ul>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Caution</strong></p>
</div>
<div class="callout-content">
<p>Depending on your computer resources (RAM, CPU), this process might take some minutes to complete. If you have a dedicated GPU device, this can take a couple of seconds instead.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="223cf0f7" class="cell" data-execution_count="54">
<div class="cell-output cell-output-display" data-execution_count="54">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-55-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="review-the-fine-tuned-segmentation" class="slide level2">
<h2>5.8. Review the fine tuned segmentation</h2>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Use the <em>opacity</em> slider to compare how the fine tuned model segments the same objects that were labeled for training.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-57-output-1.png" class="r-stretch"></section></section>
<section>
<section id="use-the-fine-tuned-model-for-inference" class="title-slide slide level1 center">
<h1>6. Use the fine tuned model for inference</h1>

</section>
<section id="create-a-mask-to-apply-the-fine-tuned-model-for-inference" class="slide level2">
<h2>6.1. Create a mask to apply the fine tuned model for inference</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Follow the steps from <a href="#/sec-mask" class="quarto-xref">Section&nbsp;4</a> to create a mask, now covering slices <span class="math inline">\(31\)</span> to <span class="math inline">\(34\)</span>.</p></li>
<li><p>Scroll down the <em>Image groups manager</em> table to show the newest mask layer grup (“mask (1)”).</p></li>
<li><p>Select the “mask (1)” layer group</p></li>
<li><p>Open the <em>Edit group properties</em> (by clicking its checkbox) and make sure that “Use as sampling mask” checkbox is checked.</p></li>
<li><p>Go to the <em>Acquisition function configuration</em> widget again and click “Run on all image groups” button.</p></li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="7c4b79bc" class="cell" data-execution_count="58">
<div class="cell-output cell-output-display" data-execution_count="58">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-59-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="inspect-the-output-of-the-fine-tuned-model" class="slide level2">
<h2>6.2. Inspect the output of the fine tuned model</h2>
<ul>
<li>Now you have a fine tuned model for nuclei segmentation that has been adapted to this image!</li>
</ul>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>The fine tuned model can be used in <em>Cellpose</em>’s GUI software, their python API package, or any other package that supports pretrained <code>cellpose</code> models.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-html/cell-61-output-1.png" class="r-stretch"></section>
<section id="segment-the-newly-masked-region-with-the-base-model-for-comaprison" class="slide level2">
<h2>6.3. Segment the newly masked region with the base model for comaprison</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Choose the “nuclei” model again from the dropdown list in the <em>Advanced segmentation parameters</em> section</p></li>
<li><p>Click the “Run on all image groups” button again</p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This will execute the segmentation process with the non-fine-tuned “nuclei” model on the same sampling positions from the last run.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="8fd947e9" class="cell" data-execution_count="62">
<div class="cell-output cell-output-display" data-execution_count="62">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-html/cell-63-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="compare-the-results-of-both-models" class="slide level2">
<h2>6.4. Compare the results of both models</h2>
<ul>
<li>Remove all the layers except the “nuclei” and “membrane” layers, and the “images segmentation” and “images segmentation [2]” layers, that are the segmentation outputs from the fine-tuned model and base model, respectively.</li>
</ul>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Click the <strong>eye</strong> icon in the “layer list” to hide/show layers instead of removing the layers.</p>
</div>
</div>
</div>



<img data-src="cellpose_tutorial_files/figure-html/cell-67-output-1.png" class="r-stretch"></section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': false,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>