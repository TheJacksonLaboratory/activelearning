<!DOCTYPE html>
<html lang="en"><head>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/tabby.min.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.6.40">

  <meta name="author" content="Fernando Cervantes">
  <title>Tutorial: How to fine tune a Cellpose model with the Active Learning plugin for Napari</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
  </style>
  <link rel="stylesheet" href="../../site_libs/revealjs/dist/theme/quarto-6573b33bb3f2fc30b4f26481e28742bf.css">
  <link href="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Tutorial: How to fine tune a Cellpose model with the Active Learning plugin for Napari</h1>

<div class="quarto-title-authors">
<div class="quarto-title-author">
<div class="quarto-title-author-name">
Fernando Cervantes 
</div>
</div>
</div>

</section>
<section>
<section id="install-napari-and-the-active-learning-plugin" class="title-slide slide level1 center">
<h1>1. Install <code>napari</code> and the Active Learning plugin</h1>

</section>
<section class="slide level2">

<h3 id="install-napari">1.1. Install <code>napari</code></h3>
<p>Follow the instructions to install <code>napari</code> from its <a href="https://napari.org/stable/tutorials/fundamentals/installation.html#napari-installation">official website</a>.</p>
<h3 id="install-the-napari-activelearning-plugin-using-pip">1.2. Install the <code>napari-activelearning</code> plugin using <code>pip</code></h3>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>If you installed <code>napari</code> using conda, activate that same environment before installing the <em>Active Learning</em> plugin.</p>
</div>
</div>
</div>
<p>Install the plugin adding <code>[cellpose]</code> to the command so all dependencies required for this tutorial are available.</p>
<pre><code>python -m pip install "napari-activelearning[cellpose]"</code></pre>
</section></section>
<section>
<section id="image-groups-management" class="title-slide slide level1 center">
<h1>2. Image groups management</h1>

</section>
<section id="load-a-sample-image" class="slide level2">
<h2>2.1. Load a sample image</h2>
<p>You can use the cells 3D image sample from napari’s built-in samples.</p>
<pre><code>File &gt; Open Sample &gt; napari builtins &gt; Cells (3D+2Ch)</code></pre>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-5-output-1.png" class="r-stretch"></section>
<section id="add-the-image-groups-manager-widget-to-naparis-window" class="slide level2">
<h2>2.2. Add the <em>Image Groups Manager</em> widget to napari’s window</h2>
<p>The <em>Image groups manager</em> can be found under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Image groups manager</code></pre>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-8-output-1.png" class="r-stretch"></section>
<section id="create-an-image-group-containing-nuclei-and-membrane-layers" class="slide level2">
<h2>2.3. Create an <em>Image Group</em> containing <em>nuclei</em> and <em>membrane</em> layers</h2>
<ol type="1">
<li><p>Select the <em>nuclei</em> and <em>membrane</em> layer.</p></li>
<li><p>Click the <em>New Image Group</em> button on the <em>Image Groups Manager</em> widget.</p></li>
</ol>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-10-output-1.png" class="r-stretch"></section>
<section id="edit-the-image-group-properties" class="slide level2">
<h2>2.4. Edit the image group properties</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<ol type="1">
<li>Select the “images” <em>channel group</em> that has been created under the new image group.</li>
</ol>
<div title="Note on image groups hierarchy">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note on image groups hierarchy</strong></p>
</div>
<div class="callout-content">
<p>The hierarchical structure of groups within this plugin is the following:</p>
<ul>
<li><p><em>Image groups</em>. Used to contain different modes of data, such as images, labels, masks, segmentation labels, etc.</p>
<ul>
<li><p><em>Layers groups</em>. These group multiple layers together, and are intended to contain data from the same mode such different channel layers of the same image.</p>
<ul>
<li><em>Layer channels</em>. This is directly related to a napari layer from the <em>layer list</em> widget, but allows to store additional information that is useful for the inference or fine-tuning process, such as the name and order of the axes.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li><p>Click the <em>Edit group properties</em> checkbox.</p></li>
<li><p>Make sure that <em>Axes order</em> is “CZYX”, otherwise, you can edit it and press <em>Enter</em> to update the axes names.</p></li>
</ol>
</div><div class="column" style="width:0.7;">
<div id="8b17ad32" class="cell" data-execution_count="13">
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-13-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section></section>
<section>
<section id="segmentation-on-image-groups" class="title-slide slide level1 center">
<h1>3. Segmentation on image groups</h1>

</section>
<section id="add-the-acquisition-function-configuration-widget-to-naparis-window" class="slide level2">
<h2>3.1. Add the <em>Acquisition function configuration</em> widget to napari’s window</h2>
<p>The <em>Acquisition function configuration</em> is under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Acquisition function configuration</code></pre>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>All <em>Active Learning</em> widgets can be <em>un-docked</em> from their current place and <em>re-docked</em> into other more convenient location within napari’s window, or even as tabs, as illustrated in this tutorial.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-16-output-1.png" class="r-stretch"></section>
<section id="define-sampling-configuration" class="slide level2">
<h2>3.2. Define sampling configuration</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li>Make sure “Input axes” are set to “ZYX”.</li>
</ol>
<div title="Note on Input axes">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note on Input axes</strong></p>
</div>
<div class="callout-content">
<p>This enables edition of the patch size at those selected <strong>spatial</strong> axes.</p>
<p>For example, the “Cells (3D+2Ch)” sample image is three-dimensional, with “ZYX” spatial axes, and has two color channels. For that image we will extract two-dimensional patches of size <span class="math inline">\(256\times256\)</span> pixels, in the “X” and “Y” spatial axes.</p>
<p>Therefore, “Input axes”=“ZYX” allows to set the patch size at spatial axes “Y” and “X” to <span class="math inline">\(256\)</span> pixels, and “Z” to <span class="math inline">\(1\)</span> in order to extract one-slice-deep patches.</p>
</div>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Change the “Model axes” to “CYX”.</li>
</ol>
<div title="Note on Model axes">
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note on Model axes</strong></p>
</div>
<div class="callout-content">
<p>This, on the other hand, specifies the order our model expects to receive its inputs.</p>
<p>In his case, the nuclei model from <code>cellpose</code> will be applied to two-dimensional images. Because the “Z” axis is not used, we drop it from the “Model axes” string. This is only possible because the “Z” axis is already set to <span class="math inline">\(1\)</span> slice deep and can be <em>squeezed</em> from the patch.</p>
<p>Additionally, we append the “C” (color channel) axis to the beginning of the string. That means that the order of the patch axes will be permuted to have the color channel as leading axis.</p>
</div>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="f7d87e7c" class="cell" data-execution_count="18">
<div class="cell-output cell-output-display" data-execution_count="17">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-18-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="set-the-size-of-the-sampling-patch" class="slide level2">
<h2>3.3. Set the size of the sampling patch</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<div id="8b9ce702" class="cell" data-execution_count="20">
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-20-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div><div class="column" style="width:0.7;">
<ol type="1">
<li>Click the “Edit patch size” checkbox</li>
<li>Change the patch size of “X” and “Y” to 256, and the “Z” axis to 1.</li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This directs the Active Learning plugin to sample at random patches of size <span class="math inline">\(256\times256\)</span> pixels and <span class="math inline">\(1\)</span> slice deep.</p>
</div>
</div>
</div>
</div></div>
</section>
<section id="sec-max-samples" class="slide level2">
<h2>3.4. Define the maximum number of samples to extract</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<div id="28a91143" class="cell" data-execution_count="22">
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-22-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div><div class="column" style="width:0.7;">
<ul>
<li>Set the “Maximum samples” to <span class="math inline">\(4\)</span> and press <em>Enter</em></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This tells the Active Learning plugin to process at most <em>four</em> samples at random from the whole image.</p>
<p>Because the image is of size <span class="math inline">\(256\times256\)</span> pixels, four whole slices will be sampled at random for segmentation.</p>
</div>
</div>
</div>
</div></div>
</section>
<section id="configure-the-segmentation-method" class="slide level2">
<h2>3.5. Configure the segmentation method</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Use the “Model” dropdown list to select the <code>cellpose</code> method</p></li>
<li><p>Click the “Advanced segmentation parameters” checkbox</p></li>
<li><p>Change the “Channel axis” to <span class="math inline">\(0\)</span></p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This makes <code>cellpose</code> to use the first axis as “Color” channel, as we already set in “Model axes”=“CYX”.</p>
</div>
</div>
</div>
<ol start="4" type="1">
<li>Change the second channel to <span class="math inline">\(1\)</span> (the right spin box in the “channels” row)</li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This tells <code>cellpose</code> to segment the first channel (<span class="math inline">\(0\)</span>) and use the second channel (<span class="math inline">\(1\)</span>) as help channel.</p>
</div>
</div>
</div>
<ol start="5" type="1">
<li>Choose the “nuclei” model from the dropdown list</li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="4caeaa04" class="cell" data-execution_count="24">
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-24-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="execute-the-segmentation-method-on-all-image-groups" class="slide level2">
<h2>3.6. Execute the segmentation method on all image groups</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ul>
<li>Click the “Run on all image groups” button</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>To execute the segmentation only on specific image groups, select the desired image groups in the <em>Image groups manager</em> widget and use the “Run on selected image groups” button instead.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.4;">
<div id="c52b2fa6" class="cell" data-execution_count="25">
<div class="cell-output cell-output-display" data-execution_count="24">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-25-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="inspect-the-segmentation-layer" class="slide level2">
<h2>3.7. Inspect the segmentation layer</h2>
<ul>
<li>We will only see four segmented slices from the whole image. This is because we set the “Maximum samples” parameter to <span class="math inline">\(4\)</span> in <a href="#/sec-max-samples" class="quarto-xref">Section&nbsp;3.4</a>.</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Because the input image is 3D, you may have to slide the “Z” index at the bottom of napari’s window to look at the samples that were segmented.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-28-output-1.png" class="r-stretch"></section></section>
<section>
<section id="sec-mask" class="title-slide slide level1 center">
<h1>4. Segment masked regions only</h1>

</section>
<section id="create-a-mask-to-restrict-the-sampling-space" class="slide level2">
<h2>4.1. Create a mask to restrict the sampling space</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol type="1">
<li><p>Switch to the <em>Image groups manager</em> tab</p></li>
<li><p>Click the “Edit mask properties” checkbox</p></li>
<li><p>Set the mask scale to <span class="math inline">\(256\)</span> for the “X” and “Y” axes, and a scale of <span class="math inline">\(1\)</span> for the “Z” axis</p></li>
<li><p>Click the “Create mask” button</p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This creates a low-resolution mask where each of its pixels corresponds to a <span class="math inline">\(256\times256\)</span> pixels region in the input image. Because the mask is low-resolution, it uses less space in memory and disk.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.4;">
<div id="0d541409" class="cell" data-execution_count="30">
<div class="cell-output cell-output-display" data-execution_count="29">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-30-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="specify-the-samplable-regions" class="slide level2">
<h2>4.2. Specify the samplable regions</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol type="1">
<li><p>Make sure the newly created layer “images mask” is selected.</p></li>
<li><p>Activate the paint brush tool (or press 2 or P keys in the keyboard as shortcuts).</p></li>
<li><p>Move the “brush size” slider to set a size of <span class="math inline">\(1\)</span> pixel in the mask scale. Because we set a scale of <span class="math inline">\(256\)</span> on “X” and “Y” axis, this translates to a region of <span class="math inline">\(256\times256\)</span> pixels on the original image.</p></li>
<li><p>Click and drag on the image to draw the mask on the current slice.</p></li>
<li><p>Move the slider at the bottom of napari’s window to navigate between slices in the “Z” axis. Select slide <span class="math inline">\(28\)</span> and draw on it as in step <span class="math inline">\(4\)</span>. Repeat with slices <span class="math inline">\(29\)</span> and <span class="math inline">\(30\)</span>.</p></li>
</ol>
</div><div class="column" style="width:0.4;">
<div id="da3348f1" class="cell" data-execution_count="32">
<div class="cell-output cell-output-display" data-execution_count="31">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-32-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="execute-the-segmentation-process-on-the-masked-regions-and-inspect-the-results" class="slide level2">
<h2>4.3. Execute the segmentation process on the masked regions and inspect the results</h2>
<ul>
<li>Run again the segmentation process (clicking “Run on all image groups” button).</li>
</ul>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>All slices between <span class="math inline">\(27\)</span> and <span class="math inline">\(30\)</span> were picked and segmented thanks to the sampling mask!</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-35-output-1.png" class="r-stretch"></section></section>
<section>
<section id="fine-tune-the-segmentation-model" class="title-slide slide level1 center">
<h1>5. Fine tune the segmentation model</h1>

</section>
<section id="add-the-label-groups-manager-widget-to-naparis-window" class="slide level2">
<h2>5.1. Add the <em>Label groups manager</em> widget to napari’s window</h2>
<p>You can find the <em>Label groups manager</em> under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Label groups manager</code></pre>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-38-output-1.png" class="r-stretch"></section>
<section id="select-a-segmented-patch-to-edit" class="slide level2">
<h2>5.2. Select a segmented patch to edit</h2>
<ul>
<li>Double click on any of the segmented patches in the viewer (e.g.&nbsp;any slice between <span class="math inline">\(27\)</span> and <span class="math inline">\(30\)</span>)</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This creates a new editable “Labels edit” layer with a copy of the selected patch.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-40-output-1.png" class="r-stretch"></section>
<section id="use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch" class="slide level2">
<h2>5.3. Use napari’s layer controls to make changes on the objects of the current patch</h2>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>You can follow <a href="https://napari.org/dev/howtos/layers/labels.html#creating-deleting-merging-and-splitting-connected-components">this tutorial</a> to learn how to use the annotation tools in napari.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-41-output-1.png" class="r-stretch"></section>
<section id="commit-changes-to-the-labels-layer" class="slide level2">
<h2>5.4. Commit changes to the labels layer</h2>
<ul>
<li>Once you have finished editing the labels, click the “Commit changes” button on the <em>Label groups manager</em></li>
</ul>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-43-output-1.png" class="r-stretch"></section>
<section id="navigate-between-segmented-patches" class="slide level2">
<h2>5.5. Navigate between segmented patches</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol type="1">
<li><p>Expand the second group of labels</p></li>
<li><p>Double-click on any of the nested items to open it for editing</p></li>
<li><p>Use the navigation buttons to move between segmented patches</p></li>
<li><p>Continue editing the segmentation in the current patch and commit the changes when finished</p></li>
<li><p>Repeat this with each of the segmented patches.</p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>Every time we run the segmentation process, a new <em>group</em> of labels is added to the <em>Label groups manager</em>.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.4;">
<div id="7b8b6064" class="cell" data-execution_count="46">
<div class="cell-output cell-output-display" data-execution_count="45">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-46-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="setup-fine-tuning-configuration" class="slide level2">
<h2>5.6. Setup fine tuning configuration</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol type="1">
<li><p>Go to the <em>Acquisition function configuration</em> widget</p></li>
<li><p>Click the “Advanced fine tuning parameters” checkbox</p></li>
<li><p>Change the “save path” to a location where you want to store the fine tuned model</p></li>
</ol>
</div><div class="column" style="width:0.4;">
<div id="a1f48dbb" class="cell" data-execution_count="50">
<div class="cell-output cell-output-display" data-execution_count="49">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-50-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="setup-fine-tuning-configuration-1" class="slide level2">
<h2>5.6. Setup fine tuning configuration</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol start="4" type="1">
<li>Change the “model name” to “nuclei_ft”</li>
</ol>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Scroll the <em>Advanced fine tuning parameters</em> widget down to show more parameters.</p>
</div>
</div>
</div>
<ol start="5" type="1">
<li><p>Set the “batch size” to <span class="math inline">\(3\)</span></p></li>
<li><p>Change the “learning rate” to <span class="math inline">\(0.0001\)</span></p></li>
</ol>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>You can modify other parameters for the training process here, such as the number of training epochs.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.4;">
<div id="39a52da7" class="cell" data-execution_count="52">
<div class="cell-output cell-output-display" data-execution_count="51">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-52-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="execute-the-fine-tuning-process" class="slide level2">
<h2>5.7. Execute the fine tuning process</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ul>
<li>Click the “Fine tune model” button to run the training process.</li>
</ul>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Caution</strong></p>
</div>
<div class="callout-content">
<p>Depending on your computer resources (RAM, CPU), this process might take some minutes to complete. If you have a dedicated GPU device, this can take a couple of seconds instead.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.4;">
<div id="8d7036be" class="cell" data-execution_count="53">
<div class="cell-output cell-output-display" data-execution_count="52">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-53-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="review-the-fine-tuned-segmentation" class="slide level2">
<h2>5.8. Review the fine tuned segmentation</h2>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Use the <em>opacity</em> slider to compare how the fine tuned model segments the same objects that were labeled for training.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-55-output-1.png" class="r-stretch"></section></section>
<section>
<section id="use-the-fine-tuned-model-for-inference" class="title-slide slide level1 center">
<h1>6. Use the fine tuned model for inference</h1>

</section>
<section id="create-a-mask-to-apply-the-fine-tuned-model-for-inference" class="slide level2">
<h2>6.1. Create a mask to apply the fine tuned model for inference</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol type="1">
<li><p>Follow the steps from <a href="#/sec-mask" class="quarto-xref">Section&nbsp;4</a> to create a mask, now covering slices <span class="math inline">\(31\)</span> to <span class="math inline">\(34\)</span>.</p></li>
<li><p>Scroll down the <em>Image groups manager</em> tree to show the newest mask layer grup (“mask (1)”).</p></li>
<li><p>Select the “mask (1)” layer group</p></li>
</ol>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>The “Group name” column in the groups tree can be resized to show the complete names.</p>
</div>
</div>
</div>
<ol start="4" type="1">
<li><p>Make sure that “Use as sampling mask” checkbox is checked.</p></li>
<li><p>Click “Run on all image groups” button in the <em>Acquisition function configuration</em> widget again.</p></li>
</ol>
</div><div class="column" style="width:0.4;">
<div id="0e2f20ee" class="cell" data-execution_count="57">
<div class="cell-output cell-output-display" data-execution_count="56">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-57-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="inspect-the-output-of-the-fine-tuned-model" class="slide level2">
<h2>6.2. Inspect the output of the fine tuned model</h2>
<ul>
<li>Now you have a fine tuned model for nuclei segmentation that has been adapted to this image!</li>
</ul>
<div class="callout callout-important callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Important</strong></p>
</div>
<div class="callout-content">
<p>The fine tuned model can be used in <em>Cellpose</em>’s GUI software, their python API package, or any other package that supports pretrained <code>cellpose</code> models.</p>
</div>
</div>
</div>

<img data-src="cellpose_tutorial_files/figure-revealjs/cell-59-output-1.png" class="r-stretch"></section>
<section id="segment-the-newly-masked-region-with-the-base-model-for-comaprison" class="slide level2">
<h2>6.3. Segment the newly masked region with the base model for comaprison</h2>
<div class="columns">
<div class="column" style="width:0.6;">
<ol type="1">
<li><p>Choose the “nuclei” model again from the dropdown list in the <em>Advanced segmentation parameters</em> section</p></li>
<li><p>Click the “Run on all image groups” button again</p></li>
</ol>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Note</strong></p>
</div>
<div class="callout-content">
<p>This will execute the segmentation process with the non-fine-tuned “nuclei” model on the same sampling positions from the last run.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.4;">
<div id="54c1c842" class="cell" data-execution_count="61">
<div class="cell-output cell-output-display" data-execution_count="60">
<div>
<figure>
<p><img data-src="cellpose_tutorial_files/figure-revealjs/cell-61-output-1.png"></p>
</figure>
</div>
</div>
</div>
</div></div>
</section>
<section id="compare-the-results-of-both-models" class="slide level2">
<h2>6.4. Compare the results of both models</h2>
<ul>
<li>Hide all the layers except the “nuclei” and “membrane” layers, and the “images segmentation [2]” and “images segmentation [3]” layers, that are the segmentation outputs from the fine-tuned model and base model, respectively.</li>
</ul>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Click the <strong>eye</strong> icon in the “layer list” to hide/show layers.</p>
</div>
</div>
</div>



<img data-src="cellpose_tutorial_files/figure-revealjs/cell-64-output-1.png" class="r-stretch"></section></section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': false,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: true,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp('/' + window.location.host + '/');
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>