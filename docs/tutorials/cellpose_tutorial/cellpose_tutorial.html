<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Fernando Cervantes">
<meta name="description" content="Tutorial for fine-tuning the “nuclei” model from cellpose to new data.">

<title>Tutorial: How to fine tune a Cellpose model with the Active Learning plugin for Napari</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e212f1f3c46809d555a1335ea96b499f.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../tutorials.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../reference/"> 
<span class="menu-text">API Reference</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Tutorial: How to fine tune a Cellpose model with the Active Learning plugin for Napari</h1>
                  <div>
        <div class="description">
          Tutorial for fine-tuning the “nuclei” model from <code>cellpose</code> to new data.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Cellpose</div>
                <div class="quarto-category">Transfer learning</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Fernando Cervantes </p>
            </div>
    </div>
      
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#install-napari-and-the-active-learning-plugin" id="toc-install-napari-and-the-active-learning-plugin" class="nav-link active" data-scroll-target="#install-napari-and-the-active-learning-plugin">1. Install <code>napari</code> and the Active Learning plugin</a>
  <ul class="collapse">
  <li><a href="#install-napari" id="toc-install-napari" class="nav-link" data-scroll-target="#install-napari">1.1. Install <code>napari</code></a></li>
  <li><a href="#install-the-napari-activelearning-plugin-using-pip" id="toc-install-the-napari-activelearning-plugin-using-pip" class="nav-link" data-scroll-target="#install-the-napari-activelearning-plugin-using-pip">1.2. Install the <code>napari-activelearning</code> plugin using <code>pip</code></a></li>
  <li><a href="#launch-napari" id="toc-launch-napari" class="nav-link" data-scroll-target="#launch-napari">1.3. Launch <code>napari</code></a></li>
  </ul></li>
  <li><a href="#image-groups-management" id="toc-image-groups-management" class="nav-link" data-scroll-target="#image-groups-management">2. Image groups management</a>
  <ul class="collapse">
  <li><a href="#load-a-sample-image" id="toc-load-a-sample-image" class="nav-link" data-scroll-target="#load-a-sample-image">2.1. Load a sample image</a></li>
  <li><a href="#add-the-image-groups-manager-widget-to-naparis-window" id="toc-add-the-image-groups-manager-widget-to-naparis-window" class="nav-link" data-scroll-target="#add-the-image-groups-manager-widget-to-naparis-window">2.2. Add the <em>Image Groups Manager</em> widget to napari’s window</a></li>
  <li><a href="#create-an-image-group-containing-nuclei-and-membrane-layers" id="toc-create-an-image-group-containing-nuclei-and-membrane-layers" class="nav-link" data-scroll-target="#create-an-image-group-containing-nuclei-and-membrane-layers">2.3. Create an <em>Image Group</em> containing <em>nuclei</em> and <em>membrane</em> layers</a></li>
  <li><a href="#edit-the-image-group-properties" id="toc-edit-the-image-group-properties" class="nav-link" data-scroll-target="#edit-the-image-group-properties">2.4. Edit the image group properties</a></li>
  </ul></li>
  <li><a href="#segmentation-on-image-groups" id="toc-segmentation-on-image-groups" class="nav-link" data-scroll-target="#segmentation-on-image-groups">3. Segmentation on image groups</a>
  <ul class="collapse">
  <li><a href="#add-the-acquisition-function-configuration-widget-to-naparis-window" id="toc-add-the-acquisition-function-configuration-widget-to-naparis-window" class="nav-link" data-scroll-target="#add-the-acquisition-function-configuration-widget-to-naparis-window">3.1. Add the <em>Acquisition function configuration</em> widget to napari’s window</a></li>
  <li><a href="#define-sampling-configuration" id="toc-define-sampling-configuration" class="nav-link" data-scroll-target="#define-sampling-configuration">3.2. Define sampling configuration</a></li>
  <li><a href="#set-the-size-of-the-sampling-patch" id="toc-set-the-size-of-the-sampling-patch" class="nav-link" data-scroll-target="#set-the-size-of-the-sampling-patch">3.3. Set the size of the sampling patch</a></li>
  <li><a href="#sec-max-samples" id="toc-sec-max-samples" class="nav-link" data-scroll-target="#sec-max-samples">3.4. Define the maximum number of samples to extract</a></li>
  <li><a href="#configure-the-segmentation-method" id="toc-configure-the-segmentation-method" class="nav-link" data-scroll-target="#configure-the-segmentation-method">3.5. Configure the segmentation method</a></li>
  <li><a href="#execute-the-segmentation-method-on-all-image-groups" id="toc-execute-the-segmentation-method-on-all-image-groups" class="nav-link" data-scroll-target="#execute-the-segmentation-method-on-all-image-groups">3.6. Execute the segmentation method on all image groups</a></li>
  <li><a href="#inspect-the-segmentation-layer" id="toc-inspect-the-segmentation-layer" class="nav-link" data-scroll-target="#inspect-the-segmentation-layer">3.7. Inspect the segmentation layer</a></li>
  </ul></li>
  <li><a href="#sec-mask" id="toc-sec-mask" class="nav-link" data-scroll-target="#sec-mask">4. Segment masked regions only</a>
  <ul class="collapse">
  <li><a href="#create-a-mask-to-restrict-the-sampling-space" id="toc-create-a-mask-to-restrict-the-sampling-space" class="nav-link" data-scroll-target="#create-a-mask-to-restrict-the-sampling-space">4.1. Create a mask to restrict the sampling space</a></li>
  <li><a href="#specify-the-samplable-regions" id="toc-specify-the-samplable-regions" class="nav-link" data-scroll-target="#specify-the-samplable-regions">4.2. Specify the samplable regions</a></li>
  <li><a href="#execute-the-segmentation-process-on-the-masked-regions" id="toc-execute-the-segmentation-process-on-the-masked-regions" class="nav-link" data-scroll-target="#execute-the-segmentation-process-on-the-masked-regions">4.3. Execute the segmentation process on the masked regions</a></li>
  <li><a href="#inspect-the-results-from-the-segmentation-applied-only-to-masked-regions" id="toc-inspect-the-results-from-the-segmentation-applied-only-to-masked-regions" class="nav-link" data-scroll-target="#inspect-the-results-from-the-segmentation-applied-only-to-masked-regions">4.4. Inspect the results from the segmentation applied only to masked regions</a></li>
  </ul></li>
  <li><a href="#fine-tune-the-segmentation-model" id="toc-fine-tune-the-segmentation-model" class="nav-link" data-scroll-target="#fine-tune-the-segmentation-model">5. Fine tune the segmentation model</a>
  <ul class="collapse">
  <li><a href="#add-the-label-groups-manager-widget-to-naparis-window" id="toc-add-the-label-groups-manager-widget-to-naparis-window" class="nav-link" data-scroll-target="#add-the-label-groups-manager-widget-to-naparis-window">5.1. Add the <em>Label groups manager</em> widget to napari’s window</a></li>
  <li><a href="#navigate-between-patches-with-the-label-groups-manager" id="toc-navigate-between-patches-with-the-label-groups-manager" class="nav-link" data-scroll-target="#navigate-between-patches-with-the-label-groups-manager">5.2. Navigate between patches with the <em>Label groups manager</em></a></li>
  <li><a href="#use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch" id="toc-use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch" class="nav-link" data-scroll-target="#use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch">5.3. Use napari’s layer controls to make changes on the objects of the current patch</a></li>
  <li><a href="#edit-labels-on-other-slices" id="toc-edit-labels-on-other-slices" class="nav-link" data-scroll-target="#edit-labels-on-other-slices">5.4. Edit labels on other slices</a></li>
  <li><a href="#select-the-layer-group-that-will-be-used-as-labels-for-fine-tuning" id="toc-select-the-layer-group-that-will-be-used-as-labels-for-fine-tuning" class="nav-link" data-scroll-target="#select-the-layer-group-that-will-be-used-as-labels-for-fine-tuning">5.5. Select the <em>layer group</em> that will be used as labels for <em>fine-tuning</em></a></li>
  <li><a href="#setup-fine-tuning-configuration" id="toc-setup-fine-tuning-configuration" class="nav-link" data-scroll-target="#setup-fine-tuning-configuration">5.6. Setup fine tuning configuration</a></li>
  <li><a href="#setup-fine-tuning-configuration-1" id="toc-setup-fine-tuning-configuration-1" class="nav-link" data-scroll-target="#setup-fine-tuning-configuration-1">5.6. Setup fine tuning configuration</a></li>
  <li><a href="#execute-the-fine-tuning-process" id="toc-execute-the-fine-tuning-process" class="nav-link" data-scroll-target="#execute-the-fine-tuning-process">5.7. Execute the fine tuning process</a></li>
  <li><a href="#review-the-fine-tuned-segmentation" id="toc-review-the-fine-tuned-segmentation" class="nav-link" data-scroll-target="#review-the-fine-tuned-segmentation">5.8. Review the fine tuned segmentation</a></li>
  </ul></li>
  <li><a href="#use-the-fine-tuned-model-for-inference" id="toc-use-the-fine-tuned-model-for-inference" class="nav-link" data-scroll-target="#use-the-fine-tuned-model-for-inference">6. Use the fine tuned model for inference</a>
  <ul class="collapse">
  <li><a href="#create-a-mask-to-apply-the-fine-tuned-model-for-inference" id="toc-create-a-mask-to-apply-the-fine-tuned-model-for-inference" class="nav-link" data-scroll-target="#create-a-mask-to-apply-the-fine-tuned-model-for-inference">6.1. Create a mask to apply the fine tuned model for inference</a></li>
  <li><a href="#inspect-the-output-of-the-fine-tuned-model" id="toc-inspect-the-output-of-the-fine-tuned-model" class="nav-link" data-scroll-target="#inspect-the-output-of-the-fine-tuned-model">6.2. Inspect the output of the fine tuned model</a></li>
  <li><a href="#segment-the-newly-masked-region-with-the-base-model-for-comaprison" id="toc-segment-the-newly-masked-region-with-the-base-model-for-comaprison" class="nav-link" data-scroll-target="#segment-the-newly-masked-region-with-the-base-model-for-comaprison">6.3. Segment the newly masked region with the base model for comaprison</a></li>
  <li><a href="#compare-the-results-of-both-models" id="toc-compare-the-results-of-both-models" class="nav-link" data-scroll-target="#compare-the-results-of-both-models">6.4. Compare the results of both models</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="cellpose_tutorial_presentation.html"><i class="bi bi-file-slides"></i>RevealJS</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="install-napari-and-the-active-learning-plugin" class="level1">
<h1>1. Install <code>napari</code> and the Active Learning plugin</h1>
<hr>
<section id="install-napari" class="level3">
<h3 class="anchored" data-anchor-id="install-napari">1.1. Install <code>napari</code></h3>
<p>Follow the instructions to install <code>napari</code> from its <a href="https://napari.org/stable/tutorials/fundamentals/installation.html#napari-installation">official website</a>.</p>
</section>
<section id="install-the-napari-activelearning-plugin-using-pip" class="level3">
<h3 class="anchored" data-anchor-id="install-the-napari-activelearning-plugin-using-pip">1.2. Install the <code>napari-activelearning</code> plugin using <code>pip</code></h3>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you installed <code>napari</code> using conda, activate that same environment before installing the <em>Active Learning</em> plugin.</p>
</div>
</div>
<p>Install the plugin adding <code>[cellpose]</code> to the command so all dependencies required for this tutorial are available.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> pip install <span class="st">"napari-activelearning[cellpose]"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="launch-napari" class="level3">
<h3 class="anchored" data-anchor-id="launch-napari">1.3. Launch <code>napari</code></h3>
<p>From a console, open <code>napari</code> with the following command:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">napari</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The first time <code>napari</code> is launched it can take more than <span class="math inline">\(30\)</span> seconds to open, so please be patient!</p>
</div>
</div>
</section>
</section>
<section id="image-groups-management" class="level1">
<h1>2. Image groups management</h1>
<section id="load-a-sample-image" class="level2">
<h2 class="anchored" data-anchor-id="load-a-sample-image">2.1. Load a sample image</h2>
<p>You can use the cells 3D image sample from napari’s built-in samples.</p>
<pre><code>File &gt; Open Sample &gt; napari builtins &gt; Cells (3D+2Ch)</code></pre>
<div id="938e6d13" class="cell" data-execution_count="4">
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="add-the-image-groups-manager-widget-to-naparis-window" class="level2">
<h2 class="anchored" data-anchor-id="add-the-image-groups-manager-widget-to-naparis-window">2.2. Add the <em>Image Groups Manager</em> widget to napari’s window</h2>
<p>The <em>Image groups manager</em> can be found under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Image groups manager</code></pre>
<div class="callout callout-style-default callout-note callout-titled" title="About the _Image groups manager_">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About the <em>Image groups manager</em>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <em>Image groups manager</em> widget is used to create <em>groups</em> of layers and their specific use within the <code>active-learning</code> plugin. It allows to specify properties and metadata of such layers (e.g.&nbsp;inputs paths, output directory, axes order, etc.) that are used by the <em>Acquisition Function Configuration</em> widget.</p>
<p>This widget allows to relate different layers using a single hierarchical structure (<em>image group</em>). Such hierarchical structure is implemented as follows:</p>
<ul>
<li><p><em>Image groups</em>. Used to contain different modes of data from a single object, such as image pixels, labels, masks, etc.</p>
<ul>
<li><p><em>Layers groups</em>. These group multiple layers of the same mode together, e.g.&nbsp;different channel layers of the same image.</p>
<ul>
<li><em>Layer channels</em>. This is directly related to elements in <code>napari</code>’s <em>layer list</em>. Moreover, <em>layer channels</em> allow to store additional information or <em>metadata</em> useful for the inference and fine-tuning processes.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="a423bde6" class="cell" data-execution_count="7">
<div class="cell-output cell-output-display" data-execution_count="7">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="create-an-image-group-containing-nuclei-and-membrane-layers" class="level2">
<h2 class="anchored" data-anchor-id="create-an-image-group-containing-nuclei-and-membrane-layers">2.3. Create an <em>Image Group</em> containing <em>nuclei</em> and <em>membrane</em> layers</h2>
<ol type="1">
<li><p>Select the <em>nuclei</em> and <em>membrane</em> layer.</p></li>
<li><p>Click the <em>New Image Group</em> button on the <em>Image Groups Manager</em> widget.</p></li>
</ol>
<div id="9416c3c8" class="cell" data-execution_count="9">
<div class="cell-output cell-output-display" data-execution_count="9">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-10-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="edit-the-image-group-properties" class="level2">
<h2 class="anchored" data-anchor-id="edit-the-image-group-properties">2.4. Edit the image group properties</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<ol type="1">
<li><p>Select the “images” layers group_ that has been created under the new image group.</p></li>
<li><p>Click the <em>Edit group properties</em> checkbox.</p></li>
<li><p>Make sure that <em>Axes order</em> is “CZYX”, otherwise, you can edit it and press <em>Enter</em> to update the axes names.</p></li>
</ol>
</div><div class="column" style="width:0.7;">
<div id="1dc741e4" class="cell" data-execution_count="12">
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-13-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
</section>
<section id="segmentation-on-image-groups" class="level1">
<h1>3. Segmentation on image groups</h1>
<section id="add-the-acquisition-function-configuration-widget-to-naparis-window" class="level2">
<h2 class="anchored" data-anchor-id="add-the-acquisition-function-configuration-widget-to-naparis-window">3.1. Add the <em>Acquisition function configuration</em> widget to napari’s window</h2>
<p>The <em>Acquisition function configuration</em> is under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Acquisition function configuration</code></pre>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>All <em>Active Learning</em> widgets can be <em>un-docked</em> from their current place and <em>re-docked</em> into other more convenient location within <code>napari</code>’s window, or even as tabs, as illustrated in this tutorial.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="About the _Acquisition function configuration_">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-5-contents" aria-controls="callout-5" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About the <em>Acquisition function configuration</em>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-5" class="callout-5-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <em>Acquisition function configuration</em> widget comprises the processes of <em>inference</em> and <em>fine tunning</em> of deep learning models.</p>
<p>This tool allows to define the sampling configuration used to retrieve patches from the <em>input</em> image at random. Such configuration involves the size on each dimension of the patches, the maximum number of patches that can be sampled from each image, and the order of the axes that are passed to the model’s inference function. Parameters for such model can also be configured within this widget.</p>
<p>The fine-tuning process can also be configured and launched from within this widget. Finally, this widget executes the inference process on the same sampled patches to compare the <em>base</em> and <em>fine-tuned</em> model performance visually.</p>
</div>
</div>
</div>
<div id="1755309a" class="cell" data-execution_count="15">
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-16-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="define-sampling-configuration" class="level2">
<h2 class="anchored" data-anchor-id="define-sampling-configuration">3.2. Define sampling configuration</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li>Make sure “Input axes” are set to “ZYX”.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="About Input axes">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-6-contents" aria-controls="callout-6" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Input axes
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-6" class="callout-6-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This enables edition of the patch size at those selected <strong>spatial</strong> axes.</p>
<p>For example, the “Cells (3D+2Ch)” sample image is three-dimensional, with “ZYX” spatial axes, and has two color channels. For that image we will extract two-dimensional patches of size <span class="math inline">\(256\times256\)</span> pixels, in the “X” and “Y” spatial axes.</p>
<p>Therefore, “Input axes”=“ZYX” allows to set the patch size at spatial axes “Y” and “X” to <span class="math inline">\(256\)</span> pixels, and “Z” to <span class="math inline">\(1\)</span> in order to extract one-slice-deep patches.</p>
</div>
</div>
</div>
<ol start="2" type="1">
<li>Change the “Model axes” to “CYX”.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled" title="About Model axes">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-7-contents" aria-controls="callout-7" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About Model axes
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-7" class="callout-7-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>This, on the other hand, specifies the order our model expects to receive its inputs.</p>
<p>In his case, the nuclei model from <code>cellpose</code> will be applied to two-dimensional images. Because the “Z” axis is not used, we drop it from the “Model axes” string. This is only possible because the “Z” axis is already set to <span class="math inline">\(1\)</span> slice deep and can be <em>squeezed</em> from the patch.</p>
<p>Additionally, we append the “C” (color channel) axis to the beginning of the string. That means that the order of the patch axes will be permuted to have the color channel as leading axis.</p>
</div>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="59327905" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display" data-execution_count="17">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="set-the-size-of-the-sampling-patch" class="level2">
<h2 class="anchored" data-anchor-id="set-the-size-of-the-sampling-patch">3.3. Set the size of the sampling patch</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<div id="b6a8d42e" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="19">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-20-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column" style="width:0.7;">
<ol type="1">
<li>Click the “Edit patch size” checkbox</li>
<li>Change the patch size of “X” and “Y” to 256, and the “Z” axis to 1.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This directs the Active Learning plugin to sample at random patches of size <span class="math inline">\(256\times256\)</span> pixels and <span class="math inline">\(1\)</span> slice deep.</p>
</div>
</div>
</div>
</div>
</section>
<section id="sec-max-samples" class="level2">
<h2 class="anchored" data-anchor-id="sec-max-samples">3.4. Define the maximum number of samples to extract</h2>
<div class="columns">
<div class="column" style="width:0.3;">
<div id="89788f59" class="cell" data-execution_count="21">
<div class="cell-output cell-output-display" data-execution_count="21">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-22-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div><div class="column" style="width:0.7;">
<ul>
<li>Set the “Maximum samples” to <span class="math inline">\(4\)</span> and press <em>Enter</em></li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This tells the Active Learning plugin to process at most <em>four</em> samples at random from the whole image.</p>
<p>Because the image is of size <span class="math inline">\(256\times256\)</span> pixels, four whole slices will be sampled at random for segmentation.</p>
</div>
</div>
</div>
</div>
</section>
<section id="configure-the-segmentation-method" class="level2">
<h2 class="anchored" data-anchor-id="configure-the-segmentation-method">3.5. Configure the segmentation method</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Use the “Model” dropdown list to select the <code>cellpose</code> method</p></li>
<li><p>Click the “Advanced segmentation parameters” checkbox</p></li>
<li><p>Change the “Channel axis” to <span class="math inline">\(0\)</span></p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This makes <code>cellpose</code> to use the first axis as “Color” channel, as we already set in “Model axes”=“CYX”.</p>
</div>
</div>
<ol start="4" type="1">
<li>Change the second channel to <span class="math inline">\(1\)</span> (the right spin box in the “channels” row)</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This tells <code>cellpose</code> to segment the first channel (<span class="math inline">\(0\)</span>) and use the second channel (<span class="math inline">\(1\)</span>) as help channel.</p>
</div>
</div>
<ol start="5" type="1">
<li>Choose the “nuclei” model from the dropdown list</li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="cbbbf6c5" class="cell" data-execution_count="23">
<div class="cell-output cell-output-display" data-execution_count="23">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-24-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="execute-the-segmentation-method-on-all-image-groups" class="level2">
<h2 class="anchored" data-anchor-id="execute-the-segmentation-method-on-all-image-groups">3.6. Execute the segmentation method on all image groups</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ul>
<li>Click the “Run on all image groups” button</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>To execute the segmentation only on specific image groups, select the desired image groups in the <em>Image groups manager</em> widget and use the “Run on selected image groups” button instead.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="52a5132f" class="cell" data-execution_count="24">
<div class="cell-output cell-output-display" data-execution_count="24">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-25-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="inspect-the-segmentation-layer" class="level2">
<h2 class="anchored" data-anchor-id="inspect-the-segmentation-layer">3.7. Inspect the segmentation layer</h2>
<ul>
<li>We will only see four segmented slices from the whole image. This is because we set the “Maximum samples” parameter to <span class="math inline">\(4\)</span> in <a href="#sec-max-samples" class="quarto-xref">Section&nbsp;3.4</a>.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Because the input image is 3D, you may have to slide the “Z” index at the bottom of napari’s window to look at the samples that were segmented.</p>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="About the newly added layers">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-14-contents" aria-controls="callout-14" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About the newly added layers
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-14" class="callout-14-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Three new layers were added to the <code>napari</code>’s layers list after executing the segmentation pipeline.</p>
<p>The “images acquisition function” presents a map of the confidence prediction made by the chosen model for each sampled patch. Lighter intensity correspond to regions where the annotator should pay attention when correcting the output labels, since those are low-confidence predictions. On the other hand, darker intensity corresponds to high-confidence predictions, and correcting these labels would not have much impact in the performance of the fine-tuned model as correcting low-confidence (lighter intensity) regions.</p>
<p>The “images sampled positions” show a low-resolution map of the regions that were sampled during the segmentation process.</p>
<p>The “images segmentation” layer are the output labels predicted by the model.</p>
<p>Note that the name of those three generated layers contain the name of the <em>image group</em> from where those patches were sampled, in this case the “images” <em>image group</em>.</p>
</div>
</div>
</div>
<div id="4b4998c8" class="cell" data-execution_count="27">
<div class="cell-output cell-output-display" data-execution_count="27">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-mask" class="level1">
<h1>4. Segment masked regions only</h1>
<section id="create-a-mask-to-restrict-the-sampling-space" class="level2">
<h2 class="anchored" data-anchor-id="create-a-mask-to-restrict-the-sampling-space">4.1. Create a mask to restrict the sampling space</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Switch to the <em>Image groups manager</em> tab</p></li>
<li><p>Click the “Edit mask properties” checkbox</p></li>
<li><p>Set the mask scale to <span class="math inline">\(256\)</span> for the “X” and “Y” axes, and a scale of <span class="math inline">\(1\)</span> for the “Z” axis</p></li>
<li><p>Click the “Create mask” button</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This creates a low-resolution mask where each of its pixels corresponds to a <span class="math inline">\(256\times256\)</span> pixels region in the input image. Because the mask is low-resolution, it uses less space in memory and disk.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="9effa677" class="cell" data-execution_count="29">
<div class="cell-output cell-output-display" data-execution_count="29">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-30-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="specify-the-samplable-regions" class="level2">
<h2 class="anchored" data-anchor-id="specify-the-samplable-regions">4.2. Specify the samplable regions</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Make sure the newly created layer “images mask” is selected.</p></li>
<li><p>Activate the <em>fill bucket</em> tool (or press <em>4</em> or <em>F</em> keys in the keyboard as shortcuts).</p></li>
<li><p>Click the image to draw the mask on the current slice.</p></li>
<li><p>Move the slider at the bottom of napari’s window to navigate between slices in the “Z” axis. Select slice <span class="math inline">\(28\)</span> and draw on it as in step <span class="math inline">\(3\)</span>. Repeat with slices <span class="math inline">\(29\)</span> and <span class="math inline">\(30\)</span>.</p></li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="c663942a" class="cell" data-execution_count="31">
<div class="cell-output cell-output-display" data-execution_count="31">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-32-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="execute-the-segmentation-process-on-the-masked-regions" class="level2">
<h2 class="anchored" data-anchor-id="execute-the-segmentation-process-on-the-masked-regions">4.3. Execute the segmentation process on the masked regions</h2>
<ul>
<li>Return to the <em>Acquisition function configuration</em> tab and run the segmentation process again (clicking “Run on all image groups” button).</li>
</ul>
<div id="c4d46238" class="cell" data-execution_count="34">
<div class="cell-output cell-output-display" data-execution_count="34">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-35-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="inspect-the-results-from-the-segmentation-applied-only-to-masked-regions" class="level2">
<h2 class="anchored" data-anchor-id="inspect-the-results-from-the-segmentation-applied-only-to-masked-regions">4.4. Inspect the results from the segmentation applied only to masked regions</h2>
<ul>
<li>All slices between <span class="math inline">\(27\)</span> and <span class="math inline">\(30\)</span> were picked and segmented thanks to the sampling mask!</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>At this point, multiple layers have been added to <code>napari</code>’s layers list and it could start to look clutered.</p>
<p>The following layers will be used in the remainder of this tutorial: “membrane”, “nuclei”, “images mask”, “images sampled positions [1]”, and “images segmentation [1]”.</p>
<p>The rest of the layers can be safely removed from the list (i.e.&nbsp;“images acquisition function [1]”, “images acquisition function”, “images sampled positions”, and “images segmentation”).</p>
</div>
</div>
<div id="93b877b1" class="cell" data-execution_count="37">
<div class="cell-output cell-output-display" data-execution_count="37">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-38-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="fine-tune-the-segmentation-model" class="level1">
<h1>5. Fine tune the segmentation model</h1>
<section id="add-the-label-groups-manager-widget-to-naparis-window" class="level2">
<h2 class="anchored" data-anchor-id="add-the-label-groups-manager-widget-to-naparis-window">5.1. Add the <em>Label groups manager</em> widget to napari’s window</h2>
<p>You can find the <em>Label groups manager</em> under the <em>Active Learning</em> plugin in napari’s plugins menu.</p>
<pre><code>Plugins &gt; Active Learning &gt; Label groups manager</code></pre>
<div class="callout callout-style-default callout-note callout-titled" title="About the _Label groups manager_">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-17-contents" aria-controls="callout-17" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
About the <em>Label groups manager</em>
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-17" class="callout-17-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The <em>Label groups manager</em> widget contains the coordinates of the sampled patches acquired by the <em>Acquisition function configuration</em> widget.</p>
<p>This widget allows to navigate between patches without serching them in the complete extent of their corresponding image. It additionally permits to edit the pixel data of the selected patch’s <em>labels</em> in order to correct the inference output in a <em>human-in-the-loop</em> approach.</p>
</div>
</div>
</div>
<div id="1804dff6" class="cell" data-execution_count="41">
<div class="cell-output cell-output-display" data-execution_count="41">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-42-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="navigate-between-patches-with-the-label-groups-manager" class="level2">
<h2 class="anchored" data-anchor-id="navigate-between-patches-with-the-label-groups-manager">5.2. Navigate between patches with the <em>Label groups manager</em></h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Select the last <em>labels group</em> “Labels of groups: images” added to the manager. If you have not removed any layers from <code>napari</code>’s layers list, it should be the second group, otherwise, it will be the only group available.</p></li>
<li><p>Select the first <em>label</em> in such group.</p></li>
<li><p>Use the navigation buttons to move between labels.</p></li>
</ol>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Selecting a <em>label</em> element in the <em>label groups manager</em> will toggle all layers visible. You can hide again any layer that blocks the visibility of objects of interest.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="859b57e1" class="cell" data-execution_count="43">
<div class="cell-output cell-output-display" data-execution_count="43">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-44-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch" class="level2">
<h2 class="anchored" data-anchor-id="use-naparis-layer-controls-to-make-changes-on-the-objects-of-the-current-patch">5.3. Use napari’s layer controls to make changes on the objects of the current patch</h2>
<ol type="1">
<li>Select the <em>label</em> associated to the patch extracted at slice <span class="math inline">\(27\)</span>. That label can be found by looking for the coordinate <span class="math inline">\((0, 0, 27, 0, 0)\)</span> in the “Sampling top-left” column of the <em>label groups manager</em> table.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This creates a new editable “Labels edit” layer with a copy of the selected patch.</p>
</div>
</div>
<ol start="2" type="1">
<li><p>Make sure the “Labels edit” layer is selected.</p></li>
<li><p>Edit the labels on the current patch with <code>napari</code>’s annotation tools.</p></li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled" title="How to use the annotation tools">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-20-contents" aria-controls="callout-20" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
How to use the annotation tools
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-20" class="callout-20-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<ol type="1">
<li><p>Select the <em>pick mode</em> tool (click the dropper icon or press key <em>5</em> or <em>L</em> on the keyboard) and click on an object in the current patch to get its label index.</p></li>
<li><p>Use the <em>paint brush</em> (click the brush icon or press key <em>2</em> or <em>P</em> on the keyboard) and add pixels missed by the model.</p></li>
<li><p>Remove extra pixels with the <em>label eraser</em> tool (click the eraser icon or press key <em>1</em> or <em>E</em> on the keyboard).</p></li>
<li><p>If an object was not segmented at all, press the <em>M</em> key on the keyboard to get the next <em>unused</em> label index, and use the <em>paint brush</em> as in step <span class="math inline">\(2\)</span> to cover the pixels of that object.</p></li>
</ol>
<p>For a more complete guide on annotation with <code>napari</code> follow <a href="https://napari.org/stable/howtos/layers/labels.html#creating-deleting-merging-and-splitting-connected-components">this tutorial</a>.</p>
</div>
</div>
</div>
<ol start="4" type="1">
<li>Click the “Commit changes” button when finished editing.</li>
</ol>
<div id="755450be" class="cell" data-execution_count="45">
<div class="cell-output cell-output-display" data-execution_count="45">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-46-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="edit-labels-on-other-slices" class="level2">
<h2 class="anchored" data-anchor-id="edit-labels-on-other-slices">5.4. Edit labels on other slices</h2>
<ul>
<li>Continue editing the labels of the other patches until these are closer to what the model is expected to predict.</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code>cellpose</code> model used in this tutorial does not work with sparse labeling, so its important that all the objects that are of interest should be labeled.</p>
<p>Additionally, the performance of the <em>fine-tuned</em> model will depend highly on how precise the objects were labeled.</p>
</div>
</div>
<div id="697e04d9" class="cell" data-execution_count="48">
<div class="cell-output cell-output-display" data-execution_count="48">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-49-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="select-the-layer-group-that-will-be-used-as-labels-for-fine-tuning" class="level2">
<h2 class="anchored" data-anchor-id="select-the-layer-group-that-will-be-used-as-labels-for-fine-tuning">5.5. Select the <em>layer group</em> that will be used as labels for <em>fine-tuning</em></h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li>Go to the <em>image groups manager</em> widget and select the “segmentation (1)” <em>layers group</em>.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>The “Group name” column in the groups table can be resized to show the complete names.</p>
</div>
</div>
<ol start="2" type="1">
<li>Open the <em>Edit group properties</em> view (clicking on the checkbox) and tick the “Use as labels” checkbox.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Any <em>layers group</em> can be used as labels for the <em>fine-tuning</em> process, just make sure the layer type is appropriate for the training workflow of the model to fine-tune.</p>
<p>In this tutorial, the labels must be of <code>napari.layers.Labels</code> type.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="c04bf5f0" class="cell" data-execution_count="50">
<div class="cell-output cell-output-display" data-execution_count="50">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-51-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="setup-fine-tuning-configuration" class="level2">
<h2 class="anchored" data-anchor-id="setup-fine-tuning-configuration">5.6. Setup fine tuning configuration</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Go to the <em>Acquisition function configuration</em> widget and click the “Advanced fine tuning parameters” checkbox</p></li>
<li><p>Change the “save path” to a location where you want to store the fine tuned model</p></li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="754ed44a" class="cell" data-execution_count="53">
<div class="cell-output cell-output-display" data-execution_count="53">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-54-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="setup-fine-tuning-configuration-1" class="level2">
<h2 class="anchored" data-anchor-id="setup-fine-tuning-configuration-1">5.6. Setup fine tuning configuration</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol start="4" type="1">
<li>Change the “model name” to “nuclei_ft”</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Scroll the <em>Advanced fine tuning parameters</em> widget down to show more parameters.</p>
</div>
</div>
<ol start="5" type="1">
<li><p>Set the “batch size” to <span class="math inline">\(3\)</span></p></li>
<li><p>Change the “learning rate” to <span class="math inline">\(0.0001\)</span></p></li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You can modify other parameters for the training process here, such as the number of training epochs.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="e17d1289" class="cell" data-execution_count="55">
<div class="cell-output cell-output-display" data-execution_count="55">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-56-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="execute-the-fine-tuning-process" class="level2">
<h2 class="anchored" data-anchor-id="execute-the-fine-tuning-process">5.7. Execute the fine tuning process</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<div class="callout callout-style-default callout-caution callout-titled" title="Double check the fine-tuning parameters!">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-26-contents" aria-controls="callout-26" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Double check the fine-tuning parameters!
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-26" class="callout-26-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Because <em>spin boxes</em> in this widget can be modified by <em>hovering</em> and <em>scrolling</em> with the mouse, it is possible to change their values when scrolling down the parameters window.</p>
<p>Make sure that the parameters are the same as the shown in the following screenshot, particularly the size of the crops used for <em>data augmentation</em> (<em>bsize</em>), and the number of images per epoch (<em>nimg per epoch</em>).</p>
<p><img src="finetuning_parameter_values.png" class="img-fluid"></p>
</div>
</div>
</div>
<ul>
<li>Click the “Fine tune model” button to run the training process.</li>
</ul>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>Depending on your computer resources (RAM, CPU), this process might take some minutes to complete. If you have a dedicated GPU device, this can take a couple of seconds instead.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="a622610e" class="cell" data-execution_count="56">
<div class="cell-output cell-output-display" data-execution_count="56">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-57-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="review-the-fine-tuned-segmentation" class="level2">
<h2 class="anchored" data-anchor-id="review-the-fine-tuned-segmentation">5.8. Review the fine tuned segmentation</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use the <em>opacity</em> slider to compare how the fine tuned model segments the same objects that were labeled for training.</p>
</div>
</div>
<div id="02a847f5" class="cell" data-execution_count="58">
<div class="cell-output cell-output-display" data-execution_count="58">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-59-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="use-the-fine-tuned-model-for-inference" class="level1">
<h1>6. Use the fine tuned model for inference</h1>
<section id="create-a-mask-to-apply-the-fine-tuned-model-for-inference" class="level2">
<h2 class="anchored" data-anchor-id="create-a-mask-to-apply-the-fine-tuned-model-for-inference">6.1. Create a mask to apply the fine tuned model for inference</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Follow the steps from <a href="#sec-mask" class="quarto-xref">Section&nbsp;4</a> to create a mask, now covering slices <span class="math inline">\(31\)</span> to <span class="math inline">\(34\)</span>.</p></li>
<li><p>Scroll down the <em>Image groups manager</em> table to show the newest mask layer grup (“mask (1)”).</p></li>
<li><p>Select the “mask (1)” layer group</p></li>
<li><p>Open the <em>Edit group properties</em> (by clicking its checkbox) and make sure that “Use as sampling mask” checkbox is checked.</p></li>
<li><p>Go to the <em>Acquisition function configuration</em> widget again and click “Run on all image groups” button.</p></li>
</ol>
</div><div class="column" style="width:0.3;">
<div id="1affd74e" class="cell" data-execution_count="60">
<div class="cell-output cell-output-display" data-execution_count="60">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-61-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="inspect-the-output-of-the-fine-tuned-model" class="level2">
<h2 class="anchored" data-anchor-id="inspect-the-output-of-the-fine-tuned-model">6.2. Inspect the output of the fine tuned model</h2>
<ul>
<li>Now you have a fine tuned model for nuclei segmentation that has been adapted to this image!</li>
</ul>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>The fine tuned model can be used in <em>Cellpose</em>’s GUI software, their python API package, or any other package that supports pretrained <code>cellpose</code> models.</p>
</div>
</div>
<div id="bfa86805" class="cell" data-execution_count="62">
<div class="cell-output cell-output-display" data-execution_count="62">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-63-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="segment-the-newly-masked-region-with-the-base-model-for-comaprison" class="level2">
<h2 class="anchored" data-anchor-id="segment-the-newly-masked-region-with-the-base-model-for-comaprison">6.3. Segment the newly masked region with the base model for comaprison</h2>
<div class="columns">
<div class="column" style="width:0.7;">
<ol type="1">
<li><p>Choose the “nuclei” model again from the dropdown list in the <em>Advanced segmentation parameters</em> section</p></li>
<li><p>Click the “Run on all image groups” button again</p></li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This will execute the segmentation process with the non-fine-tuned “nuclei” model on the same sampling positions from the last run.</p>
</div>
</div>
</div><div class="column" style="width:0.3;">
<div id="a823b523" class="cell" data-execution_count="64">
<div class="cell-output cell-output-display" data-execution_count="64">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-65-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="compare-the-results-of-both-models" class="level2">
<h2 class="anchored" data-anchor-id="compare-the-results-of-both-models">6.4. Compare the results of both models</h2>
<ul>
<li>Remove all the layers except the “nuclei” and “membrane” layers, and the “images segmentation” and “images segmentation [2]” layers, that are the segmentation outputs from the fine-tuned model and base model, respectively.</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Click the <strong>eye</strong> icon in the “layer list” to hide/show layers instead of removing the layers.</p>
</div>
</div>
<div id="255ea38f" class="cell" data-execution_count="67">
<div class="cell-output cell-output-display" data-execution_count="67">
<div>
<figure class="figure">
<p><img src="cellpose_tutorial_files/figure-html/cell-68-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>